events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    server_tokens off;

    # Rate limiting mais rigoroso
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=scan:10m rate=1r/s;

    upstream faturium_backend {
        server faturium-app:8080;
    }

    server {
        listen 7594;
        server_name _;

        # BLOQUEAR ROTA ROOT - PRIMEIRA REGRA
        location = / {
            deny all;
            access_log off;
            return 444;
        }

        # ==========================================
        # BLOQUEAR ATAQUES E SCANS AUTOMATIZADOS
        # ==========================================

        # Bloquear favicon (já existente, mas melhorado)
        location = /favicon.ico {
            access_log off;
            log_not_found off;
            return 404;
        }

        # Bloquear robots.txt
        location = /robots.txt {
            access_log off;
            return 444;
        }

        # Bloquear arquivos WordPress (principais alvos)
        location = /xmlrpc.php {
            access_log off;
            return 444;
        }

        location ~* ^/(wp-admin|wp-login\.php|wp-content|wp-includes) {
            access_log off;
            return 444;
        }

        location ~* /wp-.* {
            access_log off;
            return 444;
        }

        # Bloquear endpoints de desenvolvimento e frameworks
        location ~* ^/@vite/ {
            access_log off;
            return 444;
        }

        location ~* ^/actuator/ {
            access_log off;
            return 444;
        }

        location ~* ^/(server|server-status|server-info) {
            access_log off;
            return 444;
        }

        location ~* ^/debug/ {
            access_log off;
            return 444;
        }

        location ~* ^/telescope/ {
            access_log off;
            return 444;
        }

        location ~* ^/(about|info\.php|phpinfo) {
            access_log off;
            return 444;
        }

        # Bloquear arquivos de configuração
        location = /config.json {
            access_log off;
            return 444;
        }

        location ~* /\.(env|git|vscode|DS_Store) {
            access_log off;
            return 444;
        }

        # Bloquear endpoints específicos do seu log
        location = /login.action {
            access_log off;
            return 444;
        }

        location = /_all_dbs {
            access_log off;
            return 444;
        }

        location ~* ^/v2/_catalog {
            access_log off;
            return 444;
        }

        location ~* ^/ecp/Current/ {
            access_log off;
            return 444;
        }

        # Bloquear padrões comuns de scan
        location ~* \.(bak|backup|old|orig|save|tmp|temp|log|sql)$ {
            access_log off;
            return 444;
        }

        # Bloquear user agents suspeitos
        if ($http_user_agent ~* "(l9scan|Go-http-client|python-urllib|scanner|bot)" ) {
            access_log /var/log/nginx/blocked.log;
            return 444;
        }

        # Bloquear versões antigas do Chrome (bots)
        if ($http_user_agent ~* "Chrome/([0-9]|[1-4][0-9]|5[0-9]|6[0-6])\.") {
            return 444;
        }

        # ==========================================
        # CONFIGURAÇÕES LEGÍTIMAS
        # ==========================================

        # Health check do Nginx
        location /nginx-health {
            return 200 "nginx ok\n";
            add_header Content-Type text/plain;
        }

        # CONFIGURAÇÃO ESPECÍFICA PARA SUA ROTA SSE
        location /sse/ {
            # Rate limiting mais permissivo para SSE
            limit_req zone=api burst=10 nodelay;

            proxy_pass http://faturium_backend;

            # Headers essenciais para SSE
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
            proxy_set_header Connection '';

            # CONFIGURAÇÕES CRÍTICAS PARA SSE
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_read_timeout 3600s;
            proxy_connect_timeout 30s;
            proxy_send_timeout 3600s;

            # Headers para desabilitar cache
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";

            chunked_transfer_encoding on;
        }

        # TODAS as outras rotas (apenas requisições legítimas chegam aqui)
        location / {
            # Rate limiting mais rigoroso para requisições genéricas
            limit_req zone=scan burst=5 nodelay;

            proxy_pass http://faturium_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;

            proxy_connect_timeout 30s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
    }
}
